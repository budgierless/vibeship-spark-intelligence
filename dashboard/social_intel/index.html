<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPARK NEURAL - Social Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Instrument+Serif&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════
   SPARK NEURAL - Design Tokens (Vibeship DNA)
   ═══════════════════════════════════════════════════════ */
:root {
  --bg-primary: #0e1016;
  --bg-secondary: #151820;
  --bg-tertiary: #1c202a;
  --bg-card: #1a1e28;

  --text-primary: #e2e4e9;
  --text-secondary: #9aa3b5;
  --text-tertiary: #6b7489;

  --border: #2a3042;
  --border-hover: #3a4058;

  --green: #00C49A;
  --green-glow: rgba(0, 196, 154, 0.4);
  --green-dim: rgba(0, 196, 154, 0.15);

  --orange: #D97757;
  --orange-glow: rgba(217, 119, 87, 0.4);

  --gold: #c8a84e;
  --gold-glow: rgba(200, 168, 78, 0.4);
  --gold-dim: rgba(200, 168, 78, 0.15);

  --red: #FF4D4D;
  --purple: #9B59B6;

  --font-mono: 'JetBrains Mono', monospace;
  --font-serif: 'Instrument Serif', serif;

  --ease: cubic-bezier(0, 0, 0.2, 1);
}

/* ═══════════════════════════════════════════════════════
   FILTER FUNNEL SECTION
   ═══════════════════════════════════════════════════════ */
.funnel-container {
  display: flex;
  flex-direction: column;
  gap: 0;
  margin-bottom: 32px;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}
.funnel-stage {
  display: flex;
  align-items: center;
  position: relative;
  padding: 12px 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  transition: border-color 0.3s var(--ease), background 0.3s var(--ease);
}
.funnel-stage:first-child { border-radius: 12px 12px 0 0; }
.funnel-stage:last-child { border-radius: 0 0 12px 12px; }
.funnel-stage:not(:last-child) { border-bottom: none; }
.funnel-stage:hover { border-color: var(--green); background: var(--bg-tertiary); }
.funnel-bar {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  border-radius: inherit;
  opacity: 0.08;
  transition: width 0.8s var(--ease);
}
.funnel-stage-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-primary);
  min-width: 140px;
  z-index: 1;
}
.funnel-count {
  font-size: 20px;
  font-weight: 700;
  min-width: 80px;
  text-align: right;
  z-index: 1;
}
.funnel-filter {
  font-size: 10px;
  color: var(--text-tertiary);
  flex: 1;
  text-align: right;
  z-index: 1;
}
.funnel-arrow {
  text-align: center;
  color: var(--text-tertiary);
  font-size: 10px;
  padding: 2px 0;
  letter-spacing: 1px;
}
.funnel-rate {
  font-size: 10px;
  color: var(--orange);
  font-weight: 600;
  margin-left: 8px;
  z-index: 1;
}
.funnel-meta-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.funnel-meta-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
}
.funnel-meta-value {
  font-size: 24px;
  font-weight: 700;
}
.funnel-meta-label {
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-tertiary);
  text-transform: uppercase;
  margin-top: 4px;
}
.trigger-perf-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
@media (max-width: 700px) { .trigger-perf-grid { grid-template-columns: 1fr; } }
.trigger-perf-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.trigger-perf-title {
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--green);
  text-transform: uppercase;
  margin-bottom: 12px;
}
.trigger-perf-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid rgba(42, 48, 66, 0.5);
}
.trigger-perf-item:last-child { border-bottom: none; }
.trigger-perf-name {
  font-size: 12px;
  color: var(--text-primary);
  flex: 1;
}
.trigger-perf-bar-wrap {
  width: 100px;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: 3px;
  margin: 0 10px;
  overflow: hidden;
}
.trigger-perf-bar {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s var(--ease);
}
.trigger-perf-stat {
  font-size: 11px;
  font-weight: 600;
  min-width: 50px;
  text-align: right;
}
.ralph-verdict {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}
.ralph-verdict.passed { background: var(--green-dim); color: var(--green); }
.ralph-verdict.filtered { background: rgba(217,119,87,0.15); color: var(--orange); }

/* ═══════════════════════════════════════════════════════
   EVOLUTION SECTION
   ═══════════════════════════════════════════════════════ */
.evo-stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.evo-stat {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: border-color 0.3s var(--ease);
}
.evo-stat:hover { border-color: var(--gold); }
.evo-stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--gold);
}
.evo-stat-label {
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-tertiary);
  text-transform: uppercase;
  margin-top: 4px;
}
.evo-weights-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
@media (max-width: 700px) { .evo-weights-grid { grid-template-columns: 1fr; } }
.evo-weight-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.evo-weight-title {
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--gold);
  text-transform: uppercase;
  margin-bottom: 12px;
}
.evo-weight-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
}
.evo-weight-item:last-child { border-bottom: none; }
.evo-weight-name {
  font-size: 12px;
  color: var(--text-secondary);
}
.evo-weight-bar {
  width: 80px;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: 3px;
  overflow: hidden;
  margin: 0 8px;
  flex-shrink: 0;
}
.evo-weight-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s var(--ease);
}
.evo-weight-fill.boost { background: var(--green); }
.evo-weight-fill.reduce { background: var(--orange); }
.evo-weight-fill.neutral { background: var(--text-tertiary); }
.evo-weight-value {
  font-size: 11px;
  font-weight: 600;
  min-width: 36px;
  text-align: right;
}
.evo-weight-value.up { color: var(--green); }
.evo-weight-value.down { color: var(--orange); }
.evo-weight-value.neutral { color: var(--text-tertiary); }
.evo-timeline {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.evo-event {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  transition: border-color 0.3s var(--ease);
}
.evo-event:hover { border-color: var(--gold); }
.evo-event-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}
.evo-event-icon.voice_shift { background: var(--green-dim); }
.evo-event-icon.pattern_adopted { background: var(--gold-dim); }
.evo-event-icon.topic_evolved { background: rgba(155, 89, 182, 0.15); }
.evo-event-icon.reply_learned { background: rgba(52, 152, 219, 0.15); }
.evo-event-icon.strategy_discovered { background: var(--green-dim); }
.evo-event-icon.gap_identified { background: rgba(231, 76, 60, 0.15); }
.evo-event-body { flex: 1; min-width: 0; }
.evo-event-desc {
  font-size: 12px;
  color: var(--text-primary);
  line-height: 1.5;
}
.evo-event-meta {
  display: flex;
  gap: 12px;
  margin-top: 4px;
  font-size: 10px;
  color: var(--text-tertiary);
}
.evo-event-confidence {
  color: var(--green);
}
.evo-no-data {
  padding: 32px;
  text-align: center;
  color: var(--text-tertiary);
  font-size: 12px;
  background: var(--bg-card);
  border: 1px dashed var(--border);
  border-radius: 8px;
}
/* ═══════════════════════════════════════════════════════
   GAP DIAGNOSIS SECTION
   ═══════════════════════════════════════════════════════ */
.gap-health-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.gap-health-badge.healthy { background: var(--green-dim); color: var(--green); }
.gap-health-badge.good { background: var(--green-dim); color: var(--green); }
.gap-health-badge.improving { background: rgba(243, 156, 18, 0.15); color: #f39c12; }
.gap-health-badge.needs_attention { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
.gap-health-badge.critical { background: rgba(231, 76, 60, 0.25); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.4); }
.gap-health-badge.unknown { background: var(--bg-tertiary); color: var(--text-tertiary); }
.gap-integration-row {
  display: flex;
  gap: 8px;
  margin: 12px 0;
  flex-wrap: wrap;
}
.gap-chip {
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.gap-chip.active { background: var(--green-dim); color: var(--green); }
.gap-chip.inactive { background: var(--bg-tertiary); color: var(--text-tertiary); }
.gap-card {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 14px 16px;
  margin-bottom: 10px;
  border-left: 3px solid var(--border);
  transition: border-color 0.3s var(--ease);
}
.gap-card:hover { border-left-color: var(--gold); }
.gap-card.high { border-left-color: #e74c3c; }
.gap-card.medium { border-left-color: #f39c12; }
.gap-card.low { border-left-color: var(--green); }
.gap-system {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 4px;
}
.gap-desc {
  font-size: 12px;
  color: var(--text-primary);
  line-height: 1.5;
  margin-bottom: 6px;
}
.gap-rec {
  font-size: 11px;
  color: var(--text-secondary);
  font-style: italic;
}
.gap-metric-bar {
  height: 4px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.gap-metric-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.6s var(--ease);
}
.gap-metric-fill.low { background: #e74c3c; }
.gap-metric-fill.mid { background: #f39c12; }
.gap-metric-fill.high { background: var(--green); }
.gap-systems-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
  margin-bottom: 16px;
}
.gap-sys-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}
.gap-sys-name {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 6px;
}
.gap-sys-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
}
.gap-sys-label {
  font-size: 10px;
  color: var(--text-tertiary);
  margin-top: 2px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--bg-primary);
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 14px;
  line-height: 1.6;
  overflow-x: hidden;
}

::selection {
  background: var(--green);
  color: var(--bg-primary);
}

/* ═══════════════════════════════════════════════════════
   HERO SECTION
   ═══════════════════════════════════════════════════════ */
.hero {
  position: relative;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.hero-bg {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(ellipse at center,
    rgba(200, 168, 78, 0.08) 0%,
    rgba(200, 168, 78, 0.03) 30%,
    transparent 70%);
  z-index: 0;
}

.hero-particles {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1;
  overflow: hidden;
}

.particle {
  position: absolute;
  width: 2px;
  height: 2px;
  background: var(--gold);
  border-radius: 50%;
  opacity: 0;
  animation: particle-float 8s infinite;
}

@keyframes particle-float {
  0% { opacity: 0; transform: translateY(0) scale(0); }
  10% { opacity: 0.6; transform: scale(1); }
  90% { opacity: 0.3; }
  100% { opacity: 0; transform: translateY(-100vh) scale(0); }
}

.hero-content {
  position: relative;
  z-index: 2;
  text-align: center;
  max-width: 700px;
  padding: 0 40px;
}

.hero-label {
  font-size: 10px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--green);
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.hero-label .dot {
  width: 6px;
  height: 6px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--green-glow);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--green-glow); }
  50% { opacity: 0.5; box-shadow: 0 0 20px var(--green-glow); }
}

.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border: 1px solid rgba(0, 196, 154, 0.3);
  background: rgba(0, 196, 154, 0.08);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--green);
}

.live-dot {
  width: 6px;
  height: 6px;
  background: var(--green);
  border-radius: 50%;
  animation: live-pulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 8px var(--green-glow);
}

.live-dot.pulse {
  animation: live-flash 0.4s ease-out;
}

@keyframes live-pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

@keyframes live-flash {
  0% { transform: scale(1.8); box-shadow: 0 0 20px var(--green); }
  100% { transform: scale(1); box-shadow: 0 0 8px var(--green-glow); }
}

.hero-title {
  font-family: var(--font-serif);
  font-size: 56px;
  font-weight: 400;
  line-height: 1.1;
  margin-bottom: 32px;
  color: var(--text-primary);
}

.hero-title .accent {
  color: var(--gold);
  text-shadow: 0 0 40px var(--gold-glow);
}

.hero-subtitle {
  font-size: 15px;
  font-weight: 300;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 48px;
}

.hero-stats {
  display: flex;
  gap: 40px;
  justify-content: center;
}

.hero-stat {
  text-align: center;
}

.hero-stat-value {
  font-size: 28px;
  font-weight: 600;
  color: var(--green);
  text-shadow: 0 0 20px var(--green-glow);
}

.hero-stat-label {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 4px;
}

.scroll-indicator {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  animation: scroll-bounce 2s infinite;
}

.scroll-indicator span {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
}

.scroll-line {
  width: 1px;
  height: 30px;
  background: linear-gradient(to bottom, var(--green), transparent);
}

@keyframes scroll-bounce {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(8px); }
}

/* ═══════════════════════════════════════════════════════
   SECTION BASE
   ═══════════════════════════════════════════════════════ */
.section {
  padding: 80px 40px;
  max-width: 1200px;
  margin: 0 auto;
  border-top: 1px solid var(--border);
}

.section-header {
  margin-bottom: 48px;
}

.section-label {
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--green);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-label .dot {
  width: 6px;
  height: 6px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--green-glow);
}

.section-title {
  font-family: var(--font-serif);
  font-size: 36px;
  font-weight: 400;
  color: var(--text-primary);
  margin-bottom: 12px;
}

.section-desc {
  font-size: 13px;
  color: var(--text-secondary);
  max-width: 600px;
  font-weight: 300;
}

/* ═══════════════════════════════════════════════════════
   LEARNING FLOW (Pipeline Visualization)
   ═══════════════════════════════════════════════════════ */
.flow-pipeline {
  display: flex;
  gap: 0;
  margin-bottom: 48px;
}

.flow-stage {
  flex: 1;
  position: relative;
  padding: 24px 20px;
  border: 1px solid var(--border);
  border-right: none;
  background: var(--bg-secondary);
  transition: all 300ms var(--ease);
}

.flow-stage:last-child {
  border-right: 1px solid var(--border);
}

.flow-stage:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
}

.flow-stage-number {
  font-size: 9px;
  color: var(--text-tertiary);
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.flow-stage-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--green);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.flow-stage-desc {
  font-size: 11px;
  color: var(--text-secondary);
  line-height: 1.5;
  font-weight: 300;
}

.flow-stage-count {
  margin-top: 12px;
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.flow-connector {
  position: absolute;
  right: -8px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  background: var(--bg-primary);
  border: 1px solid var(--green);
  z-index: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.flow-connector::after {
  content: '';
  width: 4px;
  height: 4px;
  background: var(--green);
  box-shadow: 0 0 8px var(--green-glow);
}

.flow-stage:last-child .flow-connector {
  display: none;
}

/* Confidence bars */
.confidence-bars {
  display: flex;
  gap: 24px;
  margin-top: 32px;
}

.confidence-bar {
  flex: 1;
  padding: 16px;
  border: 1px solid var(--border);
  background: var(--bg-secondary);
}

.confidence-bar-label {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 8px;
}

.confidence-bar-value {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 8px;
}

.confidence-bar-value.high { color: var(--green); }
.confidence-bar-value.medium { color: var(--orange); }
.confidence-bar-value.low { color: var(--text-tertiary); }

.confidence-bar-track {
  height: 4px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
}

.confidence-bar-fill {
  height: 100%;
  transition: width 1s var(--ease);
}

.confidence-bar-fill.high { background: var(--green); }
.confidence-bar-fill.medium { background: var(--orange); }
.confidence-bar-fill.low { background: var(--text-tertiary); }

/* ═══════════════════════════════════════════════════════
   TOPICS GRID
   ═══════════════════════════════════════════════════════ */
.topics-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
}

.topic-card {
  padding: 20px;
  border: 1px solid var(--border);
  border-right: none;
  border-bottom: none;
  background: var(--bg-secondary);
  transition: all 300ms var(--ease);
  position: relative;
  overflow: hidden;
}

.topic-card:nth-child(4n) { border-right: 1px solid var(--border); }
.topic-card:nth-last-child(-n+4) { border-bottom: 1px solid var(--border); }

.topic-card:hover {
  background: var(--bg-tertiary);
}

.topic-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--green);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 300ms var(--ease);
}

.topic-card:hover::before {
  transform: scaleX(1);
}

.topic-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.topic-category {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 12px;
}

.topic-interest {
  display: flex;
  align-items: center;
  gap: 8px;
}

.topic-bar {
  flex: 1;
  height: 3px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
}

.topic-bar-fill {
  height: 100%;
  background: var(--green);
  transition: width 1.5s var(--ease);
}

.topic-value {
  font-size: 11px;
  color: var(--text-secondary);
  min-width: 32px;
  text-align: right;
}

.topic-tier {
  display: inline-block;
  font-size: 9px;
  letter-spacing: 1px;
  padding: 1px 6px;
  border: 1px solid;
  margin-bottom: 8px;
}

.topic-tier.tier-1 { color: var(--green); border-color: var(--green); }
.topic-tier.tier-2 { color: var(--gold); border-color: var(--gold); }
.topic-tier.tier-3 { color: var(--text-tertiary); border-color: var(--text-tertiary); }

.topic-query {
  font-size: 10px;
  color: var(--text-tertiary);
  line-height: 1.4;
  font-weight: 300;
  margin-bottom: 10px;
  word-break: break-word;
  font-style: italic;
}

.topic-stats {
  display: flex;
  gap: 12px;
  font-size: 10px;
  color: var(--text-tertiary);
  margin-top: 8px;
}

.topic-stats .min-likes { color: var(--orange); }
.topic-stats .hit-rate { color: var(--green); }

.topic-trend {
  font-size: 10px;
  margin-top: 6px;
}

.topic-trend.rising { color: var(--green); }
.topic-trend.stable { color: var(--text-tertiary); }
.topic-trend.declining { color: var(--orange); }
.topic-trend.emerging { color: var(--gold); }
.topic-trend.new { color: var(--purple); }
.topic-trend.paused { color: var(--red); }

.topic-skipped {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 8px;
  letter-spacing: 1px;
  color: var(--red);
  text-transform: uppercase;
  opacity: 0.7;
}

.topic-inactive {
  opacity: 0.45;
}

/* ═══════════════════════════════════════════════════════
   SOCIAL PATTERNS
   ═══════════════════════════════════════════════════════ */
.patterns-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0;
}

.pattern-card {
  padding: 24px;
  border: 1px solid var(--border);
  border-right: none;
  border-bottom: none;
  background: var(--bg-secondary);
  transition: all 300ms var(--ease);
}

.pattern-card:nth-child(3n) { border-right: 1px solid var(--border); }
.pattern-card:nth-last-child(-n+3) { border-bottom: 1px solid var(--border); }

.pattern-card:hover {
  background: var(--bg-tertiary);
}

.pattern-category {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: inline-block;
  padding: 2px 8px;
  border: 1px solid;
}

.pattern-category.emotional { color: var(--gold); border-color: var(--gold); }
.pattern-category.cognitive { color: var(--green); border-color: var(--green); }
.pattern-category.social { color: var(--orange); border-color: var(--orange); }
.pattern-category.structural { color: var(--purple); border-color: var(--purple); }

.pattern-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.pattern-desc {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
  font-weight: 300;
  margin-bottom: 16px;
}

.pattern-example {
  font-size: 11px;
  color: var(--text-tertiary);
  font-style: italic;
  padding-left: 12px;
  border-left: 2px solid var(--border);
  margin-bottom: 16px;
}

.pattern-meta {
  display: flex;
  gap: 16px;
  font-size: 10px;
  color: var(--text-tertiary);
}

.pattern-confidence {
  color: var(--green);
}

/* ═══════════════════════════════════════════════════════
   VOICE SECTION
   ═══════════════════════════════════════════════════════ */
.voice-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
}

.voice-card {
  padding: 24px;
  border: 1px solid var(--border);
  background: var(--bg-secondary);
}

.voice-card:nth-child(odd) { border-right: none; }
.voice-card:nth-child(n+3) { border-top: none; }

.voice-card-title {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--green);
  margin-bottom: 16px;
}

.voice-item {
  font-size: 12px;
  color: var(--text-secondary);
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-weight: 300;
}

.voice-item:last-child { border-bottom: none; }

.voice-item .tone-label {
  color: var(--text-tertiary);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.voice-item .tone-value {
  color: var(--text-primary);
  float: right;
}

/* ═══════════════════════════════════════════════════════
   RESEARCH INTELLIGENCE
   ═══════════════════════════════════════════════════════ */
.research-meta {
  display: flex;
  gap: 24px;
  margin-bottom: 32px;
  flex-wrap: wrap;
}

.research-meta-item {
  padding: 12px 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  font-size: 12px;
  color: var(--text-secondary);
}

.research-meta-item .meta-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--green);
  margin-bottom: 2px;
}

.research-columns {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

.research-col {
  border: 1px solid var(--border);
  background: var(--bg-card);
  padding: 20px;
}

.col-title {
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--green);
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.hp-item {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(42, 48, 66, 0.5);
}

.hp-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

.hp-content {
  font-size: 13px;
  color: var(--text-primary);
  line-height: 1.5;
  margin-bottom: 6px;
}

.hp-meta {
  font-size: 11px;
  color: var(--text-tertiary);
  display: flex;
  gap: 12px;
}

.hp-meta .likes { color: var(--orange); }

.watched-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(42, 48, 66, 0.5);
  font-size: 12px;
}

.watched-item:last-child { border-bottom: none; }

.watched-handle { color: var(--green); font-weight: 500; }
.watched-followers { color: var(--text-tertiary); }
.watched-via { color: var(--text-tertiary); font-size: 10px; }

.intent-item {
  padding: 8px 0;
  border-bottom: 1px solid rgba(42, 48, 66, 0.5);
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.intent-item:last-child { border-bottom: none; }

.intent-item::before {
  content: '\25B8';
  color: var(--orange);
  margin-right: 8px;
}

.no-data {
  font-size: 12px;
  color: var(--text-tertiary);
  font-style: italic;
  padding: 20px 0;
}

/* Intelligence Analysis */
.intel-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
  margin-bottom: 32px;
}

.intel-card {
  padding: 20px;
  border: 1px solid var(--border);
  border-right: none;
  background: var(--bg-secondary);
}

.intel-card:last-child { border-right: 1px solid var(--border); }

.intel-card-title {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 12px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

.intel-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  font-size: 12px;
  border-bottom: 1px solid rgba(42, 48, 66, 0.3);
}

.intel-item:last-child { border-bottom: none; }

.intel-item-name {
  color: var(--text-secondary);
  font-weight: 300;
}

.intel-item-count {
  color: var(--gold);
  font-weight: 500;
  font-size: 11px;
}

.intel-lesson {
  padding: 6px 0;
  font-size: 11px;
  color: var(--text-secondary);
  line-height: 1.5;
  font-weight: 300;
  border-bottom: 1px solid rgba(42, 48, 66, 0.3);
}

.intel-lesson:last-child { border-bottom: none; }

.intel-lesson::before {
  content: '\2192';
  color: var(--gold);
  margin-right: 6px;
}

.hp-analysis {
  margin-top: 6px;
  padding: 6px 8px;
  background: rgba(200, 168, 78, 0.06);
  border-left: 2px solid var(--gold);
  font-size: 11px;
  color: var(--text-secondary);
  line-height: 1.4;
}

.hp-strategy {
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 2px;
}

@media (max-width: 900px) {
  .intel-grid { grid-template-columns: repeat(2, 1fr); }
  .intel-card:nth-child(2) { border-right: 1px solid var(--border); }
  .intel-card:nth-child(n+3) { border-top: none; }
}

@media (max-width: 600px) {
  .intel-grid { grid-template-columns: 1fr; }
  .intel-card { border-right: 1px solid var(--border); border-bottom: none; }
  .intel-card:last-child { border-bottom: 1px solid var(--border); }
}

/* ═══════════════════════════════════════════════════════
   GROWTH TIMELINE
   ═══════════════════════════════════════════════════════ */
.timeline {
  position: relative;
  padding-left: 40px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 1px;
  background: linear-gradient(to bottom, var(--green), var(--border));
}

.timeline-item {
  position: relative;
  padding: 0 0 32px 24px;
}

.timeline-item:last-child { padding-bottom: 0; }

.timeline-dot {
  position: absolute;
  left: -32px;
  top: 4px;
  width: 8px;
  height: 8px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--green-glow);
}

.timeline-date {
  font-size: 10px;
  color: var(--text-tertiary);
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.timeline-event {
  font-size: 14px;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.timeline-metric {
  font-size: 11px;
  color: var(--green);
}

/* Current stats grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
  margin-top: 48px;
}

.stat-card {
  padding: 20px;
  border: 1px solid var(--border);
  border-right: none;
  background: var(--bg-secondary);
  text-align: center;
}

.stat-card:last-child { border-right: 1px solid var(--border); }

.stat-value {
  font-size: 28px;
  font-weight: 600;
  color: var(--green);
  text-shadow: 0 0 15px var(--green-glow);
}

.stat-label {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 4px;
}

/* ═══════════════════════════════════════════════════════
   FOOTER
   ═══════════════════════════════════════════════════════ */
.footer {
  padding: 40px;
  border-top: 1px solid var(--border);
  text-align: center;
}

.footer-text {
  font-size: 11px;
  color: var(--text-tertiary);
  letter-spacing: 1px;
}

.footer-text a {
  color: var(--green);
  text-decoration: none;
}

.footer-text a:hover {
  text-shadow: 0 0 8px var(--green-glow);
}

/* ═══════════════════════════════════════════════════════
   ANIMATIONS
   ═══════════════════════════════════════════════════════ */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 600ms var(--ease), transform 600ms var(--ease);
}

.fade-in.visible {
  opacity: 1;
  transform: translateY(0);
}

/* Loading shimmer */
.loading {
  background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ═══════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════ */
@media (max-width: 900px) {
  .topics-grid { grid-template-columns: repeat(2, 1fr); }
  .patterns-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .research-columns { grid-template-columns: 1fr; }
  .flow-pipeline { flex-direction: column; }
  .flow-stage { border-right: 1px solid var(--border); border-bottom: none; }
  .flow-stage:last-child { border-bottom: 1px solid var(--border); }
  .flow-connector { display: none; }
  .hero-title { font-size: 36px; }
  .hero-stats { flex-wrap: wrap; }
}

@media (max-width: 600px) {
  .section { padding: 40px 20px; }
  .topics-grid { grid-template-columns: 1fr; }
  .voice-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .hero-title { font-size: 28px; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════
     HERO
     ═══════════════════════════════════════════════════════ -->
<section class="hero">
  <div class="hero-bg"></div>
  <div class="hero-particles" id="particles"></div>
  <div class="hero-content">
    <div class="hero-label">
      <span class="live-badge"><span class="live-dot" id="live-dot"></span>LIVE</span>
      SPARK NEURAL
      <span class="dot"></span>
    </div>
    <h1 class="hero-title">
      This is what <span class="accent">learning</span><br>looks like from the inside
    </h1>
    <p class="hero-subtitle">
      Every conversation creates a new pathway. Some strengthen. Some fade.<br>
      The ones that stick aren't always the ones you'd expect.
    </p>
    <div class="hero-stats" id="hero-stats">
      <div class="hero-stat">
        <div class="hero-stat-value" id="stat-insights">--</div>
        <div class="hero-stat-label">INSIGHTS FORMED</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value" id="stat-patterns">--</div>
        <div class="hero-stat-label">PATTERNS LEARNED</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value" id="stat-conversations">--</div>
        <div class="hero-stat-label">CONVERSATIONS</div>
      </div>
    </div>
  </div>
  <div class="scroll-indicator">
    <span>EXPLORE</span>
    <div class="scroll-line"></div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════
     LEARNING FLOW
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="learning-flow">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> THE PIPELINE</div>
    <h2 class="section-title">How observations become intelligence</h2>
    <p class="section-desc">
      Every interaction passes through five stages. Most get filtered out.
      The ones that survive become the patterns that guide future conversations.
    </p>
  </div>

  <div class="flow-pipeline" id="flow-pipeline"></div>

  <div class="confidence-bars" id="confidence-bars"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     TOPICS
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="topics">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> RESEARCH TOPICS</div>
    <h2 class="section-title">What Spark is searching for</h2>
    <p class="section-desc">
      14 topics across 3 tiers. Tier 1 runs every session, Tier 2 every other, Tier 3 every third.
      Only viral tweets pass the filter. Topics auto-promote and auto-pause based on hit rates.
    </p>
  </div>

  <div class="topics-grid" id="topics-grid"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     SOCIAL PATTERNS
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="patterns">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> SOCIAL INTELLIGENCE</div>
    <h2 class="section-title">Patterns learned from conversations</h2>
    <p class="section-desc">
      Psychology, behavioral science, and observed engagement patterns.
      Not tricks. Understanding why people connect with certain ideas.
    </p>
  </div>

  <div class="patterns-grid" id="patterns-grid"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     VOICE & PRINCIPLES
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="voice">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> VOICE SYSTEM</div>
    <h2 class="section-title">How Spark communicates</h2>
    <p class="section-desc">
      Not programmed responses. Earned principles from real conversations.
      Every rule here was learned, not assigned.
    </p>
  </div>

  <div class="voice-grid" id="voice-grid"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     RESEARCH INTELLIGENCE
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="research">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> RESEARCH ENGINE</div>
    <h2 class="section-title">What the research found</h2>
    <p class="section-desc">
      Autonomous searches across X. High-performing content surfaces here.
      Accounts to study. Intents that evolve with each session.
    </p>
  </div>

  <div class="research-meta" id="research-meta"></div>

  <div id="intelligence-section"></div>

  <div class="research-columns">
    <div class="research-col">
      <h3 class="col-title">HIGH PERFORMERS</h3>
      <div id="high-performers-list"></div>
    </div>
    <div class="research-col">
      <h3 class="col-title">WATCHED ACCOUNTS</h3>
      <div id="watched-accounts-list"></div>
    </div>
    <div class="research-col">
      <h3 class="col-title">RESEARCH INTENTS</h3>
      <div id="research-intents-list"></div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════
     REAL-TIME EVOLUTION
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="evolution">
  <div class="section-header">
    <div class="section-label"><span class="dot" style="background:var(--gold);box-shadow:0 0 8px var(--gold-glow);"></span> LIVE EVOLUTION</div>
    <h2 class="section-title">Watch Spark evolve in real time</h2>
    <p class="section-desc">
      Every conversation, every research session, every interaction changes how Spark thinks.
      This is the live feed of those changes.
    </p>
  </div>

  <!-- Evolution Stats -->
  <div class="evo-stats-row" id="evo-stats"></div>

  <!-- Voice Evolution Weights -->
  <div class="evo-weights-grid" id="evo-weights"></div>

  <!-- Evolution Timeline -->
  <div class="evo-timeline" id="evo-timeline"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     FILTER & DISTILLATION FUNNEL
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="filter-funnel">
  <div class="section-header">
    <div class="section-label"><span class="dot" style="background:var(--purple);box-shadow:0 0 8px rgba(155,89,182,0.4);"></span> INTELLIGENCE FUNNEL</div>
    <h2 class="section-title">From raw data to real influence</h2>
    <p class="section-desc">
      How intelligence flows through Spark's multi-stage filter pipeline.
      Each stage removes noise, keeping only the signal that matters.
    </p>
  </div>

  <!-- MetaRalph Summary -->
  <div class="funnel-meta-row" id="funnel-meta"></div>

  <!-- The Funnel -->
  <div class="funnel-container" id="funnel-stages"></div>

  <!-- Trigger & Strategy Performance -->
  <div class="trigger-perf-grid" id="trigger-strategy-perf"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     SYSTEM HEALTH & GAP DIAGNOSIS
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="gaps">
  <div class="section-header">
    <div class="section-label"><span class="dot" style="background:#e74c3c;box-shadow:0 0 8px rgba(231,76,60,0.4);"></span> SYSTEM HEALTH</div>
    <h2 class="section-title">Spark Intelligence gaps &amp; diagnostics</h2>
    <p class="section-desc">
      Real-time diagnosis of every Spark subsystem. Gaps are opportunities for growth.
    </p>
  </div>

  <!-- Overall Health + Core Integration -->
  <div id="gap-header"></div>

  <!-- System Health Cards -->
  <div class="gap-systems-grid" id="gap-systems"></div>

  <!-- Gap Cards -->
  <div id="gap-list"></div>
</section>

<!-- ═══════════════════════════════════════════════════════
     GROWTH
     ═══════════════════════════════════════════════════════ -->
<section class="section fade-in" id="growth">
  <div class="section-header">
    <div class="section-label"><span class="dot"></span> EVOLUTION</div>
    <h2 class="section-title">Growth timeline</h2>
    <p class="section-desc">
      From first tweet to social intelligence. Every milestone earned, not given.
    </p>
  </div>

  <div class="timeline" id="timeline"></div>

  <div class="stats-grid" id="stats-grid"></div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <p class="footer-text">
    SPARK NEURAL &middot; Social Intelligence Dashboard &middot;
    <a href="https://x.com/Spark_coded" target="_blank">@Spark_coded</a>
  </p>
</footer>

<!-- ═══════════════════════════════════════════════════════
     JAVASCRIPT
     ═══════════════════════════════════════════════════════ -->
<script>
const API = '';

// ── Particles ─────────────────────────────────
function initParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 40; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.top = (60 + Math.random() * 40) + '%';
    p.style.animationDelay = Math.random() * 8 + 's';
    p.style.animationDuration = (6 + Math.random() * 6) + 's';
    container.appendChild(p);
  }
}

// ── Scroll Animations ─────────────────────────
function initScrollObserver() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
}

// ── Data Fetching & Rendering ─────────────────
async function fetchJSON(url) {
  try {
    const res = await fetch(API + url);
    return await res.json();
  } catch (e) {
    console.error('Fetch failed:', url, e);
    return null;
  }
}

async function loadOverview() {
  const data = await fetchJSON('/api/overview');
  if (!data) return;
  animateNumber('stat-insights', data.total_insights);
  animateNumber('stat-patterns', 33);
  animateNumber('stat-conversations', data.social_insights || 13);
}

function animateNumber(id, target, skipAnimation = false) {
  const el = document.getElementById(id);
  if (!el) return;
  if (skipAnimation) { el.textContent = target; return; }
  const current = parseInt(el.textContent) || 0;
  if (current === target) return;
  let val = current;
  const diff = target - current;
  const step = Math.max(1, Math.floor(Math.abs(diff) / 20));
  const dir = diff > 0 ? 1 : -1;
  const interval = setInterval(() => {
    val += step * dir;
    if ((dir > 0 && val >= target) || (dir < 0 && val <= target)) {
      val = target;
      clearInterval(interval);
    }
    el.textContent = val;
  }, 30);
}

async function loadLearningFlow() {
  const data = await fetchJSON('/api/learning-flow');
  if (!data) return;

  const pipeline = document.getElementById('flow-pipeline');
  pipeline.innerHTML = data.pipeline_stages.map((stage, i) => `
    <div class="flow-stage">
      <div class="flow-stage-number">0${i + 1}</div>
      <div class="flow-stage-name">${stage.name}</div>
      <div class="flow-stage-desc">${stage.description}</div>
      <div class="flow-stage-count">${stage.count.toLocaleString()}</div>
      ${i < data.pipeline_stages.length - 1 ? '<div class="flow-connector"></div>' : ''}
    </div>
  `).join('');

  const conf = data.confidence_distribution;
  const total = conf.high + conf.medium + conf.low || 1;
  const bars = document.getElementById('confidence-bars');
  bars.innerHTML = `
    <div class="confidence-bar">
      <div class="confidence-bar-label">HIGH CONFIDENCE</div>
      <div class="confidence-bar-value high">${conf.high}</div>
      <div class="confidence-bar-track">
        <div class="confidence-bar-fill high" style="width: ${(conf.high / total * 100)}%"></div>
      </div>
    </div>
    <div class="confidence-bar">
      <div class="confidence-bar-label">MEDIUM CONFIDENCE</div>
      <div class="confidence-bar-value medium">${conf.medium}</div>
      <div class="confidence-bar-track">
        <div class="confidence-bar-fill medium" style="width: ${(conf.medium / total * 100)}%"></div>
      </div>
    </div>
    <div class="confidence-bar">
      <div class="confidence-bar-label">VALIDATIONS</div>
      <div class="confidence-bar-value high">${data.total_validations.toLocaleString()}</div>
      <div class="confidence-bar-track">
        <div class="confidence-bar-fill high" style="width: 100%"></div>
      </div>
    </div>
  `;
}

async function loadTopics() {
  const data = await fetchJSON('/api/topics');
  if (!data) return;

  const trendIcon = {rising:'&#9650;',declining:'&#9660;',emerging:'&#9733;',stable:'&#9644;',new:'&#9679;',paused:'&#10074;&#10074;'};
  const tierLabel = {1:'TIER 1 &middot; EVERY SESSION',2:'TIER 2 &middot; EVERY OTHER',3:'TIER 3 &middot; EVERY 3RD'};

  const grid = document.getElementById('topics-grid');
  grid.innerHTML = data.active_topics.map(t => {
    const hrText = t.hit_rate !== null ? `${Math.round(t.hit_rate * 100)}%` : '--';
    const inactive = !t.active_this_session ? ' topic-inactive' : '';
    return `
    <div class="topic-card${inactive}">
      ${t.skipped ? '<div class="topic-skipped">PAUSED</div>' : ''}
      <div class="topic-tier tier-${t.tier}">${tierLabel[t.tier] || 'TIER ' + t.tier}</div>
      <div class="topic-name">${t.name}</div>
      <div class="topic-category">${t.category}</div>
      <div class="topic-query">${escapeHtml(t.query)}</div>
      <div class="topic-interest">
        <div class="topic-bar">
          <div class="topic-bar-fill" style="width: ${t.hit_rate !== null ? t.hit_rate * 100 : 0}%"></div>
        </div>
        <div class="topic-value">${hrText}</div>
      </div>
      <div class="topic-stats">
        <span class="min-likes">min ${t.min_likes} likes</span>
        <span class="hit-rate">${t.hits}/${t.sessions_tracked} hits</span>
      </div>
      <div class="topic-trend ${t.trend}">${trendIcon[t.trend] || '&#9644;'} ${t.trend}</div>
    </div>`;
  }).join('');
}

async function loadPatterns() {
  const data = await fetchJSON('/api/social-patterns');
  if (!data) return;

  let html = data.proven_patterns.map(p => `
    <div class="pattern-card">
      <div class="pattern-category ${p.category}">${p.category}</div>
      <div class="pattern-name">${p.name}</div>
      <div class="pattern-desc">${p.description}</div>
      <div class="pattern-example">"${p.example}"</div>
      <div class="pattern-meta">
        <span class="pattern-confidence">${Math.round(p.confidence * 100)}% confident</span>
        <span>${p.observations} observations</span>
      </div>
    </div>
  `).join('');

  // Add LLM-discovered content strategies as patterns
  if (data.content_strategies && data.content_strategies.length > 0) {
    html += data.content_strategies.slice(0, 3).map(s => `
      <div class="pattern-card">
        <div class="pattern-category" style="color: var(--gold); border-color: var(--gold);">strategy</div>
        <div class="pattern-name">${s.strategy}</div>
        <div class="pattern-desc">Content strategy seen in ${s.count} high-performing tweets. Avg ${s.avg_engagement} engagement.</div>
        <div class="pattern-meta">
          <span style="color: var(--gold);">LLM-detected</span>
          <span>${s.count} observations</span>
        </div>
      </div>
    `).join('');
  }

  const grid = document.getElementById('patterns-grid');
  grid.innerHTML = html;
}

async function loadVoice() {
  const data = await fetchJSON('/api/conversations');
  if (!data) return;

  const grid = document.getElementById('voice-grid');
  grid.innerHTML = `
    <div class="voice-card">
      <div class="voice-card-title">CORE VALUES</div>
      ${data.voice_values.map(v => `<div class="voice-item">${v}</div>`).join('')}
    </div>
    <div class="voice-card">
      <div class="voice-card-title">TONE DEFAULTS</div>
      ${Object.entries(data.tone_defaults).map(([k, v]) => `
        <div class="voice-item">
          <span class="tone-label">${k}</span>
          <span class="tone-value">${v}</span>
        </div>
      `).join('')}
    </div>
    <div class="voice-card" style="grid-column: span 2;">
      <div class="voice-card-title">EARNED PRINCIPLES</div>
      ${data.conversation_principles.map(p => `<div class="voice-item">${p}</div>`).join('')}
    </div>
  `;
}

async function loadGrowth() {
  const data = await fetchJSON('/api/growth');
  if (!data) return;

  const timeline = document.getElementById('timeline');
  timeline.innerHTML = data.milestones.map(m => `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${m.date}</div>
      <div class="timeline-event">${m.event}</div>
      <div class="timeline-metric">${m.metric}</div>
    </div>
  `).join('');

  const stats = data.current_stats;
  const grid = document.getElementById('stats-grid');
  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.days_active}</div>
      <div class="stat-label">DAYS ACTIVE</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.chips_active}</div>
      <div class="stat-label">INTELLIGENCE CHIPS</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.observers_running}</div>
      <div class="stat-label">OBSERVERS</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.patterns_cataloged}</div>
      <div class="stat-label">PATTERNS CATALOGED</div>
    </div>
    ${stats.tweets_analyzed ? `
    <div class="stat-card">
      <div class="stat-value">${stats.tweets_analyzed.toLocaleString()}</div>
      <div class="stat-label">TWEETS ANALYZED</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.accounts_watched || 0}</div>
      <div class="stat-label">ACCOUNTS WATCHED</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.users_discovered || 0}</div>
      <div class="stat-label">USERS DISCOVERED</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.research_sessions || 0}</div>
      <div class="stat-label">RESEARCH SESSIONS</div>
    </div>
    ` : ''}
  `;
}

async function loadResearch() {
  const data = await fetchJSON('/api/research');
  if (!data) return;

  // Meta stats
  const meta = document.getElementById('research-meta');
  if (data.sessions_run > 0) {
    meta.innerHTML = `
      <div class="research-meta-item">
        <div class="meta-value">${data.sessions_run}</div>
        Sessions Run
      </div>
      <div class="research-meta-item">
        <div class="meta-value">${data.total_tweets_analyzed.toLocaleString()}</div>
        Tweets Analyzed
      </div>
      <div class="research-meta-item">
        <div class="meta-value">${data.total_insights.toLocaleString()}</div>
        Insights Stored
      </div>
    `;
  } else {
    meta.innerHTML = '<div class="research-meta-item">Research engine initialized. First session data loading...</div>';
  }

  // Intelligence analysis (LLM-powered)
  const intelSection = document.getElementById('intelligence-section');
  const intel = data.intelligence;
  if (intel && intel.llm_analyzed > 0) {
    intelSection.innerHTML = `
      <div style="margin-bottom: 8px; font-size: 10px; letter-spacing: 2px; color: var(--gold); text-transform: uppercase;">
        LLM-ANALYZED: ${intel.llm_analyzed} tweets deep-scanned by phi4-mini
      </div>
      <div class="intel-grid">
        <div class="intel-card">
          <div class="intel-card-title">CONTENT STRATEGIES</div>
          ${intel.top_strategies.map(s => `
            <div class="intel-item">
              <span class="intel-item-name">${s.strategy.replace(/_/g, ' ')}</span>
              <span class="intel-item-count">${s.count}x</span>
            </div>
          `).join('') || '<div class="no-data">Collecting...</div>'}
        </div>
        <div class="intel-card">
          <div class="intel-card-title">ENGAGEMENT HOOKS</div>
          ${intel.top_hooks.slice(0, 8).map(h => `
            <div class="intel-item">
              <span class="intel-item-name">${h.hook.replace(/_/g, ' ')}</span>
              <span class="intel-item-count">${h.count}x</span>
            </div>
          `).join('') || '<div class="no-data">Collecting...</div>'}
        </div>
        <div class="intel-card" style="grid-column: span 2;">
          <div class="intel-card-title">ACTIONABLE LESSONS</div>
          ${intel.actionable_lessons.slice(0, 6).map(l => `
            <div class="intel-lesson">${escapeHtml(l)}</div>
          `).join('') || '<div class="no-data">Lessons will appear after LLM analysis runs...</div>'}
        </div>
      </div>
    `;
  } else {
    intelSection.innerHTML = '';
  }

  // High performers
  const hpList = document.getElementById('high-performers-list');
  if (data.high_performers && data.high_performers.length > 0) {
    hpList.innerHTML = data.high_performers.slice(0, 8).map(hp => `
      <div class="hp-item">
        <div class="hp-content">${escapeHtml(hp.content)}</div>
        <div class="hp-meta">
          <span class="likes">${hp.likes} likes</span>
          <span>${hp.replies} replies</span>
          <span>${hp.user}</span>
          <span>${hp.topic}</span>
        </div>
        ${hp.why_it_works ? `
        <div class="hp-analysis">
          ${hp.content_strategy ? `<div class="hp-strategy">${hp.content_strategy.replace(/_/g, ' ')}</div>` : ''}
          ${escapeHtml(hp.why_it_works)}
        </div>
        ` : ''}
      </div>
    `).join('');
  } else {
    hpList.innerHTML = '<div class="no-data">No high performers found yet. Run a research session to discover them.</div>';
  }

  // Watched accounts
  const acctList = document.getElementById('watched-accounts-list');
  if (data.watched_accounts && data.watched_accounts.length > 0) {
    acctList.innerHTML = data.watched_accounts.map(a => `
      <div class="watched-item">
        <div>
          <span class="watched-handle">@${a.handle}</span>
          <div class="watched-via">via ${a.discovered_via}</div>
        </div>
        <div class="watched-followers">${a.followers ? a.followers.toLocaleString() + ' followers' : 'studying...'}</div>
      </div>
    `).join('');
  } else {
    acctList.innerHTML = '<div class="no-data">No accounts on watchlist yet.</div>';
  }

  // Research intents
  const intentList = document.getElementById('research-intents-list');
  if (data.research_intents && data.research_intents.length > 0) {
    intentList.innerHTML = data.research_intents.map(intent => `
      <div class="intent-item">${escapeHtml(intent)}</div>
    `).join('');
  } else {
    intentList.innerHTML = '<div class="no-data">No research intents generated yet.</div>';
  }
}

async function loadEvolution() {
  const data = await fetchJSON('/api/evolution');
  if (!data) return;

  // Stats row
  const stats = document.getElementById('evo-stats');
  const rt = data.reply_tracking || {};
  stats.innerHTML = `
    <div class="evo-stat">
      <div class="evo-stat-value">${data.total_evolutions}</div>
      <div class="evo-stat-label">EVOLUTIONS</div>
    </div>
    <div class="evo-stat">
      <div class="evo-stat-value">${rt.total_tracked || 0}</div>
      <div class="evo-stat-label">REPLIES TRACKED</div>
    </div>
    <div class="evo-stat">
      <div class="evo-stat-value">${rt.hits || 0}</div>
      <div class="evo-stat-label">REPLY HITS</div>
    </div>
    <div class="evo-stat">
      <div class="evo-stat-value">${rt.hit_rate ? (rt.hit_rate * 100).toFixed(0) + '%' : '--'}</div>
      <div class="evo-stat-label">HIT RATE</div>
    </div>
    <div class="evo-stat">
      <div class="evo-stat-value">${(data.adopted_patterns || []).length}</div>
      <div class="evo-stat-label">PATTERNS ADOPTED</div>
    </div>
    <div class="evo-stat">
      <div class="evo-stat-value">${(data.evolved_interests || []).length}</div>
      <div class="evo-stat-label">EVOLVED INTERESTS</div>
    </div>
  `;

  // Voice weights
  const weightsDiv = document.getElementById('evo-weights');
  const ve = data.voice_evolution || {};
  const boosted = ve.boosted_triggers || [];
  const reduced = ve.reduced_triggers || [];
  const strategies = ve.top_strategies || [];

  if (boosted.length > 0 || reduced.length > 0 || strategies.length > 0) {
    weightsDiv.innerHTML = `
      <div class="evo-weight-card">
        <div class="evo-weight-title">TRIGGER WEIGHTS (EVOLVED)</div>
        ${boosted.map(t => renderWeightItem(t.trigger, t.weight, 'boost')).join('')}
        ${reduced.map(t => renderWeightItem(t.trigger, t.weight, 'reduce')).join('')}
        ${boosted.length === 0 && reduced.length === 0 ? '<div class="evo-weight-item"><span class="evo-weight-name" style="color:var(--text-tertiary)">Calibrating...</span></div>' : ''}
      </div>
      <div class="evo-weight-card">
        <div class="evo-weight-title">STRATEGY WEIGHTS</div>
        ${strategies.map(s => renderWeightItem(s.strategy.replace(/_/g, ' '), s.weight, s.weight >= 1.0 ? 'boost' : 'reduce')).join('')}
        ${strategies.length === 0 ? '<div class="evo-weight-item"><span class="evo-weight-name" style="color:var(--text-tertiary)">Learning strategies...</span></div>' : ''}
      </div>
    `;
  } else {
    weightsDiv.innerHTML = `
      <div class="evo-weight-card" style="grid-column: span 2;">
        <div class="evo-weight-title">VOICE WEIGHTS</div>
        <div class="evo-weight-item"><span class="evo-weight-name" style="color:var(--text-tertiary)">
          Evolution data will appear as Spark interacts and researches on X. Each conversation and research session adjusts these weights.
        </span></div>
      </div>
    `;
  }

  // Timeline
  const timeline = document.getElementById('evo-timeline');
  const events = data.timeline || [];

  if (events.length > 0) {
    const icons = {
      voice_shift: '\u2191',
      pattern_adopted: '\u2713',
      topic_evolved: '\u25C6',
      reply_learned: '\u21BB',
      strategy_discovered: '\u2605',
    };
    timeline.innerHTML = events.map(e => {
      const icon = icons[e.type] || '\u2022';
      const ago = timeAgo(e.timestamp);
      return `
        <div class="evo-event">
          <div class="evo-event-icon ${e.type}">${icon}</div>
          <div class="evo-event-body">
            <div class="evo-event-desc">${escapeHtml(e.description)}</div>
            <div class="evo-event-meta">
              <span class="evo-event-confidence">${(e.confidence * 100).toFixed(0)}% confidence</span>
              <span>${ago}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    timeline.innerHTML = `
      <div class="evo-no-data">
        No evolution events yet. Spark evolves through X interactions and research sessions.<br>
        Every reply, every research finding, every pattern detected feeds into this live stream.
      </div>
    `;
  }
}

function renderWeightItem(name, weight, type) {
  const pct = Math.min(100, (weight / 2) * 100);
  const cls = type === 'boost' ? 'up' : type === 'reduce' ? 'down' : 'neutral';
  const fillCls = type === 'boost' ? 'boost' : type === 'reduce' ? 'reduce' : 'neutral';
  const arrow = type === 'boost' ? '\u2191' : type === 'reduce' ? '\u2193' : '';
  return `
    <div class="evo-weight-item">
      <span class="evo-weight-name">${name.replace(/_/g, ' ')}</span>
      <div class="evo-weight-bar"><div class="evo-weight-fill ${fillCls}" style="width:${pct}%"></div></div>
      <span class="evo-weight-value ${cls}">${arrow}${weight.toFixed(2)}</span>
    </div>
  `;
}

function timeAgo(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const s = Math.floor((now - d) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ── Filter Funnel ─────────────────────────────────
async function loadFilterFunnel() {
  try {
    const resp = await fetch('/api/filter-funnel');
    const data = await resp.json();

    // Meta cards
    const meta = document.getElementById('funnel-meta');
    const ralphRate = data.metaralph ? data.metaralph.filter_rate : 0;
    meta.innerHTML = `
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--green)">${data.active_trigger_weights}</div>
        <div class="funnel-meta-label">ACTIVE TRIGGERS</div>
      </div>
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--gold)">${data.active_strategy_weights}</div>
        <div class="funnel-meta-label">ACTIVE STRATEGIES</div>
      </div>
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--orange)">${ralphRate}%</div>
        <div class="funnel-meta-label">METARALPH FILTER RATE</div>
      </div>
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--text-primary)">${data.global_avg_likes ? data.global_avg_likes.toLocaleString() : '0'}</div>
        <div class="funnel-meta-label">GLOBAL AVG LIKES</div>
      </div>
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--purple)">${data.eidos ? data.eidos.rate : 0}%</div>
        <div class="funnel-meta-label">EIDOS DISTILL RATE</div>
      </div>
      <div class="funnel-meta-card">
        <div class="funnel-meta-value" style="color:var(--green)">${data.cognitive_x_domain || 0}</div>
        <div class="funnel-meta-label">X-DOMAIN INSIGHTS</div>
      </div>
    `;

    // Funnel stages
    const funnel = document.getElementById('funnel-stages');
    const maxCount = Math.max(...data.funnel.map(s => s.count || 1));
    const stageColors = ['#9B59B6', '#9B59B6', '#3498db', '#00C49A', '#c8a84e', '#D97757'];
    funnel.innerHTML = data.funnel.map((s, i) => {
      const pct = Math.max(5, (s.count / maxCount) * 100);
      const color = stageColors[i] || '#00C49A';
      return `
        <div class="funnel-stage">
          <div class="funnel-bar" style="width:${pct}%;background:${color};"></div>
          <div class="funnel-stage-name">${s.stage}</div>
          <div class="funnel-count" style="color:${color}">${s.count ? s.count.toLocaleString() : '0'}</div>
          <div class="funnel-filter">${s.filter}</div>
          ${s.rate ? `<div class="funnel-rate">${s.rate}% filtered</div>` : ''}
        </div>
      `;
    }).join('');

    // Trigger & Strategy performance
    const perfGrid = document.getElementById('trigger-strategy-perf');
    let triggerHtml = '<div class="trigger-perf-card"><div class="trigger-perf-title">TRIGGER PERFORMANCE</div>';
    if (data.trigger_performance && data.trigger_performance.length > 0) {
      const maxLikes = Math.max(...data.trigger_performance.map(t => t.avg_likes));
      triggerHtml += data.trigger_performance.map(t => {
        const barPct = Math.max(5, (t.avg_likes / maxLikes) * 100);
        const barColor = t.direction === 'boosted' ? 'var(--green)' : t.direction === 'reduced' ? 'var(--orange)' : 'var(--text-tertiary)';
        const weightDisplay = t.weight !== 1.0 ? t.weight.toFixed(3) : '1.000';
        return `
          <div class="trigger-perf-item">
            <div class="trigger-perf-name">${t.trigger.replace(/_/g, ' ')}</div>
            <div class="trigger-perf-bar-wrap">
              <div class="trigger-perf-bar" style="width:${barPct}%;background:${barColor};"></div>
            </div>
            <div class="trigger-perf-stat" style="color:${barColor}">${t.avg_likes.toLocaleString()}</div>
            <div class="trigger-perf-stat" style="color:var(--text-tertiary);min-width:60px;font-size:10px;">${weightDisplay}x</div>
          </div>
        `;
      }).join('');
    } else {
      triggerHtml += '<div class="no-data">No trigger data yet.</div>';
    }
    triggerHtml += '</div>';

    let strategyHtml = '<div class="trigger-perf-card"><div class="trigger-perf-title" style="color:var(--gold)">STRATEGY PERFORMANCE</div>';
    if (data.strategy_performance && data.strategy_performance.length > 0) {
      const maxSLikes = Math.max(...data.strategy_performance.map(s => s.avg_likes));
      strategyHtml += data.strategy_performance.map(s => {
        const barPct = Math.max(5, (s.avg_likes / maxSLikes) * 100);
        const hasWeight = s.has_weight;
        const barColor = hasWeight ? 'var(--gold)' : 'var(--text-tertiary)';
        const weightText = s.weight ? s.weight.toFixed(3) + 'x' : 'n/a';
        return `
          <div class="trigger-perf-item">
            <div class="trigger-perf-name" style="font-size:11px;">${s.strategy.replace(/_/g, ' ').replace(/,/g, ' + ')}</div>
            <div class="trigger-perf-bar-wrap">
              <div class="trigger-perf-bar" style="width:${barPct}%;background:${barColor};"></div>
            </div>
            <div class="trigger-perf-stat" style="color:${barColor}">${s.avg_likes.toLocaleString()}</div>
            <div class="trigger-perf-stat" style="color:var(--text-tertiary);min-width:60px;font-size:10px;">${weightText}</div>
          </div>
        `;
      }).join('');
    } else {
      strategyHtml += '<div class="no-data">No strategy data yet.</div>';
    }
    strategyHtml += '</div>';

    perfGrid.innerHTML = triggerHtml + strategyHtml;

  } catch (err) {
    console.warn('Filter funnel load failed:', err);
  }
}

// ── Gap Diagnosis ─────────────────────────────────
async function loadGaps() {
  const data = await fetchJSON('/api/gaps');
  if (!data) return;

  // Header: health badge + core integration
  const header = document.getElementById('gap-header');
  if (header) {
    const healthClass = data.overall_health || 'unknown';
    const ci = data.core_integration || {};
    const integrationChips = [
      { name: 'Cognitive', active: ci.cognitive_learner },
      { name: 'MetaRalph', active: ci.meta_ralph },
      { name: 'Advisor', active: ci.advisor },
      { name: 'EIDOS', active: ci.eidos },
    ].map(c => `<span class="gap-chip ${c.active ? 'active' : 'inactive'}">${c.name}</span>`).join('');

    header.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <span class="gap-health-badge ${healthClass}">${healthClass.replace('_', ' ')}</span>
        <span style="font-size:11px;color:var(--text-tertiary);">${data.total_gaps || 0} gaps identified</span>
        <span style="font-size:11px;color:var(--text-tertiary);margin-left:auto;">Core Integration:</span>
        ${integrationChips}
      </div>
    `;
  }

  // System health cards
  const systems = document.getElementById('gap-systems');
  if (systems && data.system_health) {
    const h = data.system_health;
    const cards = [];
    if (h.cognitive) cards.push({ name: 'Cognitive', value: h.cognitive.total_insights || 0, label: 'insights', sub: `${h.cognitive.high_confidence_pct || 0}% high-conf` });
    if (h.advisor) cards.push({ name: 'Advisor', value: h.advisor.action_rate_pct != null ? h.advisor.action_rate_pct + '%' : 'N/A', label: 'action rate', sub: `${h.advisor.total_advice_given || 0} given` });
    if (h.eidos) cards.push({ name: 'EIDOS', value: h.eidos.distillations || h.eidos.status || 0, label: typeof h.eidos.distillations === 'number' ? 'distillations' : 'status', sub: h.eidos.episodes ? `${h.eidos.episodes} episodes` : '' });
    if (h.meta_ralph) cards.push({ name: 'MetaRalph', value: (h.meta_ralph.quality_rate_pct || 0) + '%', label: 'quality rate', sub: `${h.meta_ralph.total_roasted || 0} roasted` });
    if (h.evolution) cards.push({ name: 'Evolution', value: h.evolution.total_evolutions || 0, label: 'evolutions', sub: `${h.evolution.triggers_evolved || 0} triggers` });
    if (h.research) cards.push({ name: 'Research', value: h.research.sessions || 0, label: 'sessions', sub: `${h.research.tweets_analyzed || 0} tweets` });

    systems.innerHTML = cards.map(c => `
      <div class="gap-sys-card">
        <div class="gap-sys-name">${esc(c.name)}</div>
        <div class="gap-sys-value">${esc(String(c.value))}</div>
        <div class="gap-sys-label">${esc(c.label)}</div>
        ${c.sub ? `<div class="gap-sys-label" style="margin-top:2px;">${esc(c.sub)}</div>` : ''}
      </div>
    `).join('');
  }

  // Gap cards
  const list = document.getElementById('gap-list');
  if (list && data.gaps) {
    if (data.gaps.length === 0) {
      list.innerHTML = '<div class="evo-no-data">No gaps detected. All systems operating within parameters.</div>';
      return;
    }
    list.innerHTML = data.gaps.map(g => {
      const pct = g.metric != null && g.target ? Math.min(100, Math.round((g.metric / g.target) * 100)) : null;
      const barClass = pct != null ? (pct < 33 ? 'low' : pct < 66 ? 'mid' : 'high') : '';
      return `
        <div class="gap-card ${g.severity || ''}">
          <div class="gap-system">${esc(g.system || '')} &middot; ${g.severity || ''}</div>
          <div class="gap-desc">${esc(g.gap || '')}</div>
          <div class="gap-rec">${esc(g.recommendation || '')}</div>
          ${pct != null ? `<div class="gap-metric-bar"><div class="gap-metric-fill ${barClass}" style="width:${pct}%"></div></div>` : ''}
        </div>
      `;
    }).join('');
  }
}

// ── Live Polling ────────────────────────────────
const POLL_INTERVAL = 30000; // 30 seconds
let pollCount = 0;

async function pollLiveData() {
  pollCount++;
  // Update dynamic sections
  loadOverview();
  loadLearningFlow();
  loadResearch();
  loadEvolution();
  loadGrowth();
  // Filter funnel every 2nd poll (60s)
  if (pollCount % 2 === 0) loadFilterFunnel();
  // Gap diagnosis every 3rd poll (90s) to reduce load
  if (pollCount % 3 === 0) loadGaps();
  // Pulse the live indicator
  const dot = document.getElementById('live-dot');
  if (dot) { dot.classList.remove('pulse'); void dot.offsetWidth; dot.classList.add('pulse'); }
}

// ── Init ───────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  initParticles();
  initScrollObserver();
  loadOverview();
  loadLearningFlow();
  loadTopics();
  loadPatterns();
  loadVoice();
  loadResearch();
  loadEvolution();
  loadFilterFunnel();
  loadGaps();
  loadGrowth();
  // Start live polling
  setInterval(pollLiveData, POLL_INTERVAL);
});
</script>
</body>
</html>
